{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="cal-page">
  <div class="cal-toolbar">
    <div class="cal-title">
      <h2>カレンダー</h2>
      <div class="cal-hint">空き枠（緑）をクリックすると予約作成へ進みます</div>

      <div class="cal-legend">
        <span class="badge badge-avail">空き</span>
        <span class="badge badge-full">満員</span>
        {% if is_coach_user %}
          <span class="badge badge-resv">予約</span>
        {% endif %}
      </div>
    </div>

    <form method="get" class="cal-controls">
      <label class="cal-label">コーチ</label>
      <select name="coach" class="cal-select" onchange="this.form.submit()">
        {% for c in coaches %}
          <option value="{{ c.id }}" {% if selected_coach_id == c.id|stringformat:"s" %}selected{% endif %}>
            {{ c.username }}
          </option>
        {% endfor %}
      </select>
      <noscript><button type="submit" class="cal-btn">表示</button></noscript>
    </form>
  </div>

  <div id="calendar" class="cal-box"></div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<style>
  .cal-page { max-width: 1100px; margin: 0 auto; padding: 12px; }
  .cal-toolbar { display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap; }
  .cal-title h2 { margin:0; font-size: 22px; }
  .cal-hint { color:#666; font-size:12px; margin-top:4px; }

  .cal-legend { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
  .badge { display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid #eee; background:#fff; color:#333; }
  .badge::before { content:""; width:10px; height:10px; border-radius:999px; display:inline-block; }
  .badge-avail::before { background:#2ecc71; }
  .badge-full::before { background:#e74c3c; }
  .badge-resv::before { background:#3498db; }

  .cal-controls { display:flex; align-items:center; gap:8px; }
  .cal-label { font-size: 12px; color:#444; }
  .cal-select { padding:8px 10px; border:1px solid #ddd; border-radius:10px; }
  .cal-btn { padding:8px 10px; border:1px solid #111; background:#111; color:#fff; border-radius:10px; cursor:pointer; }

  .cal-box { margin-top: 12px; background:#fff; border:1px solid #eee; border-radius:14px; padding: 8px; }
  @media (max-width: 720px) { .cal-box { padding: 4px; } }

  @media (max-width: 720px) {
    .fc .fc-toolbar-title { font-size: 16px; }
    .fc .fc-button { padding: 6px 8px; }
  }

  /* 月表示で文字が詰まりやすいので少し見やすく */
  .fc-daygrid-event .fc-event-title,
  .fc-daygrid-event .fc-event-time {
    font-size: 11px;
    line-height: 1.2;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const calendarEl = document.getElementById("calendar");
  const coachId = "{{ selected_coach_id|default:'' }}";

  if (!coachId) {
    calendarEl.innerHTML = "<div style='padding:12px;color:#666'>コーチが選択されていません</div>";
    return;
  }

  const isMobile = window.matchMedia && window.matchMedia("(max-width: 720px)").matches;

  const pad2 = (n) => String(n).padStart(2, "0");
  const fmtHM = (d) => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: isMobile ? "timeGridWeek" : "dayGridMonth",
    locale: "ja",
    firstDay: 1,
    height: isMobile ? "auto" : 720,

    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "dayGridMonth,timeGridWeek"
    },

    buttonText: { today: "今日", month: "月", week: "週" },
    navLinks: true,
    nowIndicator: true,

    // ✅ 月表示でも時間を見やすく（枠は start-end を出す）
    eventContent: function(arg) {
      const ev = arg.event;
      const p = ev.extendedProps || {};
      const title = (ev.title || "").trim();
      const start = ev.start;
      const end = ev.end;

      // time表示：枠（空き/満員）は「HH:MM-HH:MM」
      let timeText = "";
      if (start && end && (p.kind === "availability" || p.kind === "full")) {
        timeText = `${fmtHM(start)}-${fmtHM(end)} `;
      } else if (arg.timeText) {
        // 予約（青）などは FullCalendar標準の timeText を使う
        timeText = arg.timeText ? (arg.timeText + " ") : "";
      }

      // 表示用ノードを返す
      const wrap = document.createElement("div");
      wrap.style.whiteSpace = "normal";

      const t = document.createElement("span");
      t.textContent = timeText + title;
      wrap.appendChild(t);

      return { domNodes: [wrap] };
    },

    events: function(fetchInfo, successCallback, failureCallback) {
      const params = new URLSearchParams({
        coach_id: coachId,
        start: fetchInfo.startStr,
        end: fetchInfo.endStr
      });

      fetch("{% url 'club:calendar_events_api' %}?" + params.toString(), {
        credentials: "same-origin"
      })
      .then(r => r.json())
      .then(data => successCallback(data))
      .catch(err => failureCallback(err));
    },

    // ✅ 空き（緑）だけ予約作成へ。満員（赤）・予約（青）は無効。
    eventClick: function(info) {
      const ev = info.event;
      const p = ev.extendedProps || {};
      const title = (ev.title || "").trim();

      if (p.kind === "full" || p.kind === "reservation") {
        info.jsEvent.preventDefault();
        return;
      }

      if (p.reservation_url) {
        window.location.href = p.reservation_url;
        return;
      }

      // 保険：タイトルが「空き」で始まる場合だけURLを組み立てる
      if (title.startsWith("空き")) {
        const start = ev.start;
        const end = ev.end;
        if (!start || !end) return;

        const ymd = `${start.getFullYear()}-${pad2(start.getMonth()+1)}-${pad2(start.getDate())}`;
        const st = fmtHM(start);
        const et = fmtHM(end);

        const url = "{% url 'club:reservation_create' %}"
          + `?coach=${encodeURIComponent(coachId)}`
          + `&date=${encodeURIComponent(ymd)}`
          + `&start=${encodeURIComponent(st)}`
          + `&end=${encodeURIComponent(et)}`;

        window.location.href = url;
        return;
      }

      info.jsEvent.preventDefault();
    }
  });

  calendar.render();
});
</script>
{% endblock %}
